C:\Users\Administrator\Desktop\bin>AntiHook.exe Disassemble X64 fffff804716329a0 0x172
FFFFF804716329A0  4053                push rbx
FFFFF804716329A2  56                  push rsi
FFFFF804716329A3  57                  push rdi
FFFFF804716329A4  4883ec30            sub rsp, 0x30
FFFFF804716329A8  8bf2                mov esi, edx
FFFFF804716329AA  488bf9              mov rdi, rcx
FFFFF804716329AD  0f0d89b8040000      prefetchw byte ptr ds:[rcx+0x4B8]
FFFFF804716329B4  4c8b81b8040000      mov r8, qword ptr ds:[rcx+0x4B8]
FFFFF804716329BB  41f6c00f            test r8b, 0x0F
FFFFF804716329BF  7416                jz 0xFFFFF804716329D7
FFFFF804716329C1  498d50ff            lea rdx, qword ptr ds:[r8-0x01]
FFFFF804716329C5  498bc0              mov rax, r8
FFFFF804716329C8  f0480fb191b8040000  lock cmpxchg qword ptr ds:[rcx+0x4B8], rdx
FFFFF804716329D1  0f85a7000000        jnz 0xFFFFF80471632A7E
FFFFF804716329D7  498bd8              mov rbx, r8
FFFFF804716329DA  4183e00f            and r8d, 0x0F
FFFFF804716329DE  4883e3f0            and rbx, 0xFFFFFFFFFFFFFFF0
FFFFF804716329E2  4183f801            cmp r8d, 0x01
FFFFF804716329E6  7622                jbe 0xFFFFF80471632A0A
FFFFF804716329E8  833d29a6ae0000      cmp dword ptr ds:[0xFFFFF8047211D018], 0x00
FFFFF804716329EF  0f8592db2400        jnz 0xFFFFF80471880587
FFFFF804716329F5  4885db              test rbx, rbx
FFFFF804716329F8  0f8490000000        jz 0xFFFFF80471632A8E
FFFFF804716329FE  488bc3              mov rax, rbx
FFFFF80471632A01  4883c430            add rsp, 0x30
FFFFF80471632A05  5f                  pop rdi
FFFFF80471632A06  5e                  pop rsi
FFFFF80471632A07  5b                  pop rbx
FFFFF80471632A08  c3                  ret
FFFFF80471632A09  cc                  int3
FFFFF80471632A0A  4585c0              test r8d, r8d
FFFFF80471632A0D  747f                jz 0xFFFFF80471632A8E
FFFFF80471632A0F  b80f000000          mov eax, 0x0F
FFFFF80471632A14  f0480fc143d0        lock xadd qword ptr ds:[rbx-0x30], rax
FFFFF80471632A1A  4885c0              test rax, rax
FFFFF80471632A1D  0f8e47db2400        jle 0xFFFFF8047188056A
FFFFF80471632A23  0f0d89b8040000      prefetchw byte ptr ds:[rcx+0x4B8]
FFFFF80471632A2A  488b81b8040000      mov rax, qword ptr ds:[rcx+0x4B8]
FFFFF80471632A31  488bc8              mov rcx, rax
FFFFF80471632A34  83e10f              and ecx, 0x0F
FFFFF80471632A37  4883c10f            add rcx, 0x0F
FFFFF80471632A3B  4883f90f            cmp rcx, 0x0F
FFFFF80471632A3F  772b                jnbe 0xFFFFF80471632A6C
FFFFF80471632A41  488bc8              mov rcx, rax
FFFFF80471632A44  4883e1f0            and rcx, 0xFFFFFFFFFFFFFFF0
FFFFF80471632A48  483bd9              cmp rbx, rcx
FFFFF80471632A4B  751f                jnz 0xFFFFF80471632A6C
FFFFF80471632A4D  488d480f            lea rcx, qword ptr ds:[rax+0x0F]
FFFFF80471632A51  f0480fb18fb8040000  lock cmpxchg qword ptr ds:[rdi+0x4B8], rcx
FFFFF80471632A5A  748c                jz 0xFFFFF804716329E8
FFFFF80471632A5C  488bc8              mov rcx, rax
FFFFF80471632A5F  83e10f              and ecx, 0x0F
FFFFF80471632A62  4883c10f            add rcx, 0x0F
FFFFF80471632A66  4883f90f            cmp rcx, 0x0F
FFFFF80471632A6A  76d5                jbe 0xFFFFF80471632A41
FFFFF80471632A6C  48c7c0f1ffffff      mov rax, 0xFFFFFFFFFFFFFFF1
FFFFF80471632A73  f0480fc143d0        lock xadd qword ptr ds:[rbx-0x30], rax
FFFFF80471632A79  e96affffff          jmp 0xFFFFF804716329E8
FFFFF80471632A7E  4c8bc0              mov r8, rax
FFFFF80471632A81  a80f                test al, 0x0F
FFFFF80471632A83  0f8538ffffff        jnz 0xFFFFF804716329C1
FFFFF80471632A89  e949ffffff          jmp 0xFFFFF804716329D7
FFFFF80471632A8E  48896c2458          mov qword ptr ss:[rsp+0x58], rbp
FFFFF80471632A93  488d8f38040000      lea rcx, qword ptr ds:[rdi+0x438]
FFFFF80471632A9A  4c89742460          mov qword ptr ss:[rsp+0x60], r14
FFFFF80471632A9F  33d2                xor edx, edx
FFFFF80471632AA1  654c8b342588010000  mov r14, qword ptr gs:[0x0000000000000188]
FFFFF80471632AAA  6641ff8ee4010000    dec word ptr ds:[r14+0x1E4]
FFFFF80471632AB2  90                  nop
FFFFF80471632AB3  e8d8e2ffff          call 0xFFFFF80471630D90
FFFFF80471632AB8  488b9fb8040000      mov rbx, qword ptr ds:[rdi+0x4B8]
FFFFF80471632ABF  4883e3f0            and rbx, 0xFFFFFFFFFFFFFFF0
FFFFF80471632AC3  740a                jz 0xFFFFF80471632ACF
FFFFF80471632AC5  8bd6                mov edx, esi
FFFFF80471632AC7  488bcb              mov rcx, rbx
FFFFF80471632ACA  e8d13c0800          call 0xFFFFF804716B67A0
FFFFF80471632ACF  33c9                xor ecx, ecx
FFFFF80471632AD1  b811000000          mov eax, 0x11
FFFFF80471632AD6  f0480fb18f38040000  lock cmpxchg qword ptr ds:[rdi+0x438], rcx
FFFFF80471632ADF  7523                jnz 0xFFFFF80471632B04
FFFFF80471632AE1  488d8f38040000      lea rcx, qword ptr ds:[rdi+0x438]
FFFFF80471632AE8  e873e7ffff          call 0xFFFFF80471631260
FFFFF80471632AED  498bce              mov rcx, r14
FFFFF80471632AF0  e80bccffff          call 0xFFFFF8047162F700
FFFFF80471632AF5  4c8b742460          mov r14, qword ptr ss:[rsp+0x60]
FFFFF80471632AFA  488b6c2458          mov rbp, qword ptr ss:[rsp+0x58]
FFFFF80471632AFF  e9fafeffff          jmp 0xFFFFF804716329FE
FFFFF80471632B04  488d8f38040000      lea rcx, qword ptr ds:[rdi+0x438]
FFFFF80471632B0B  e830ac0800          call 0xFFFFF804716BD740
FFFFF80471632B10  ebcf                jmp 0xFFFFF80471632AE1

C:\Users\Administrator\Desktop\bin>

上面是程序输出
下面是windbg显示

0: kd> u nt!PsReferencePrimaryTokenWithTag L5a
nt!PsReferencePrimaryTokenWithTag:
fffff804`716329a0 4053            push    rbx
fffff804`716329a2 56              push    rsi
fffff804`716329a3 57              push    rdi
fffff804`716329a4 4883ec30        sub     rsp,30h
fffff804`716329a8 8bf2            mov     esi,edx
fffff804`716329aa 488bf9          mov     rdi,rcx
fffff804`716329ad 0f0d89b8040000  prefetchw [rcx+4B8h]
fffff804`716329b4 4c8b81b8040000  mov     r8,qword ptr [rcx+4B8h]
fffff804`716329bb 41f6c00f        test    r8b,0Fh
fffff804`716329bf 7416            je      nt!PsReferencePrimaryTokenWithTag+0x37 (fffff804`716329d7)
fffff804`716329c1 498d50ff        lea     rdx,[r8-1]
fffff804`716329c5 498bc0          mov     rax,r8
fffff804`716329c8 f0480fb191b8040000 lock cmpxchg qword ptr [rcx+4B8h],rdx
fffff804`716329d1 0f85a7000000    jne     nt!PsReferencePrimaryTokenWithTag+0xde (fffff804`71632a7e)
fffff804`716329d7 498bd8          mov     rbx,r8
fffff804`716329da 4183e00f        and     r8d,0Fh
fffff804`716329de 4883e3f0        and     rbx,0FFFFFFFFFFFFFFF0h
fffff804`716329e2 4183f801        cmp     r8d,1
fffff804`716329e6 7622            jbe     nt!PsReferencePrimaryTokenWithTag+0x6a (fffff804`71632a0a)
fffff804`716329e8 833d29a6ae0000  cmp     dword ptr [nt!ObpTraceFlags (fffff804`7211d018)],0
fffff804`716329ef 0f8592db2400    jne     nt!PsReferencePrimaryTokenWithTag+0x24dbe7 (fffff804`71880587)
fffff804`716329f5 4885db          test    rbx,rbx
fffff804`716329f8 0f8490000000    je      nt!PsReferencePrimaryTokenWithTag+0xee (fffff804`71632a8e)
fffff804`716329fe 488bc3          mov     rax,rbx
fffff804`71632a01 4883c430        add     rsp,30h
fffff804`71632a05 5f              pop     rdi
fffff804`71632a06 5e              pop     rsi
fffff804`71632a07 5b              pop     rbx
fffff804`71632a08 c3              ret
fffff804`71632a09 cc              int     3
fffff804`71632a0a 4585c0          test    r8d,r8d
fffff804`71632a0d 747f            je      nt!PsReferencePrimaryTokenWithTag+0xee (fffff804`71632a8e)
fffff804`71632a0f b80f000000      mov     eax,0Fh
fffff804`71632a14 f0480fc143d0    lock xadd qword ptr [rbx-30h],rax
fffff804`71632a1a 4885c0          test    rax,rax
fffff804`71632a1d 0f8e47db2400    jle     nt!PsReferencePrimaryTokenWithTag+0x24dbca (fffff804`7188056a)
fffff804`71632a23 0f0d89b8040000  prefetchw [rcx+4B8h]
fffff804`71632a2a 488b81b8040000  mov     rax,qword ptr [rcx+4B8h]
fffff804`71632a31 488bc8          mov     rcx,rax
fffff804`71632a34 83e10f          and     ecx,0Fh
fffff804`71632a37 4883c10f        add     rcx,0Fh
fffff804`71632a3b 4883f90f        cmp     rcx,0Fh
fffff804`71632a3f 772b            ja      nt!PsReferencePrimaryTokenWithTag+0xcc (fffff804`71632a6c)
fffff804`71632a41 488bc8          mov     rcx,rax
fffff804`71632a44 4883e1f0        and     rcx,0FFFFFFFFFFFFFFF0h
fffff804`71632a48 483bd9          cmp     rbx,rcx
fffff804`71632a4b 751f            jne     nt!PsReferencePrimaryTokenWithTag+0xcc (fffff804`71632a6c)
fffff804`71632a4d 488d480f        lea     rcx,[rax+0Fh]
fffff804`71632a51 f0480fb18fb8040000 lock cmpxchg qword ptr [rdi+4B8h],rcx
fffff804`71632a5a 748c            je      nt!PsReferencePrimaryTokenWithTag+0x48 (fffff804`716329e8)
fffff804`71632a5c 488bc8          mov     rcx,rax
fffff804`71632a5f 83e10f          and     ecx,0Fh
fffff804`71632a62 4883c10f        add     rcx,0Fh
fffff804`71632a66 4883f90f        cmp     rcx,0Fh
fffff804`71632a6a 76d5            jbe     nt!PsReferencePrimaryTokenWithTag+0xa1 (fffff804`71632a41)
fffff804`71632a6c 48c7c0f1ffffff  mov     rax,0FFFFFFFFFFFFFFF1h
fffff804`71632a73 f0480fc143d0    lock xadd qword ptr [rbx-30h],rax
fffff804`71632a79 e96affffff      jmp     nt!PsReferencePrimaryTokenWithTag+0x48 (fffff804`716329e8)
fffff804`71632a7e 4c8bc0          mov     r8,rax
fffff804`71632a81 a80f            test    al,0Fh
fffff804`71632a83 0f8538ffffff    jne     nt!PsReferencePrimaryTokenWithTag+0x21 (fffff804`716329c1)
fffff804`71632a89 e949ffffff      jmp     nt!PsReferencePrimaryTokenWithTag+0x37 (fffff804`716329d7)
fffff804`71632a8e 48896c2458      mov     qword ptr [rsp+58h],rbp
fffff804`71632a93 488d8f38040000  lea     rcx,[rdi+438h]
fffff804`71632a9a 4c89742460      mov     qword ptr [rsp+60h],r14
fffff804`71632a9f 33d2            xor     edx,edx
fffff804`71632aa1 654c8b342588010000 mov   r14,qword ptr gs:[188h]
fffff804`71632aaa 6641ff8ee4010000 dec     word ptr [r14+1E4h]
fffff804`71632ab2 90              nop
fffff804`71632ab3 e8d8e2ffff      call    nt!ExAcquirePushLockSharedEx (fffff804`71630d90)
fffff804`71632ab8 488b9fb8040000  mov     rbx,qword ptr [rdi+4B8h]
fffff804`71632abf 4883e3f0        and     rbx,0FFFFFFFFFFFFFFF0h
fffff804`71632ac3 740a            je      nt!PsReferencePrimaryTokenWithTag+0x12f (fffff804`71632acf)
fffff804`71632ac5 8bd6            mov     edx,esi
fffff804`71632ac7 488bcb          mov     rcx,rbx
fffff804`71632aca e8d13c0800      call    nt!ObfReferenceObjectWithTag (fffff804`716b67a0)
fffff804`71632acf 33c9            xor     ecx,ecx
fffff804`71632ad1 b811000000      mov     eax,11h
fffff804`71632ad6 f0480fb18f38040000 lock cmpxchg qword ptr [rdi+438h],rcx
fffff804`71632adf 7523            jne     nt!PsReferencePrimaryTokenWithTag+0x164 (fffff804`71632b04)
fffff804`71632ae1 488d8f38040000  lea     rcx,[rdi+438h]
fffff804`71632ae8 e873e7ffff      call    nt!KeAbPostRelease (fffff804`71631260)
fffff804`71632aed 498bce          mov     rcx,r14
fffff804`71632af0 e80bccffff      call    nt!KeLeaveCriticalRegionThread (fffff804`7162f700)
fffff804`71632af5 4c8b742460      mov     r14,qword ptr [rsp+60h]
fffff804`71632afa 488b6c2458      mov     rbp,qword ptr [rsp+58h]
fffff804`71632aff e9fafeffff      jmp     nt!PsReferencePrimaryTokenWithTag+0x5e (fffff804`716329fe)
fffff804`71632b04 488d8f38040000  lea     rcx,[rdi+438h]
fffff804`71632b0b e830ac0800      call    nt!ExfReleasePushLockShared (fffff804`716bd740)
fffff804`71632b10 ebcf            jmp     nt!PsReferencePrimaryTokenWithTag+0x141 (fffff804`71632ae1)

